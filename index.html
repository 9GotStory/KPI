<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard - ระบบติดตามตัวชี้วัด</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Thai Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.8s ease-in-out; }
        .status-passed { background: linear-gradient(135deg, #10b981, #059669); }
        .status-failed { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <div class="p-2 bg-blue-500 rounded-lg">
                        <i data-lucide="bar-chart-3" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">KPI Dashboard</h1>
                        <p class="text-sm text-gray-600">ระบบติดตามตัวชี้วัดหน่วยบริการสาธารณสุข</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>รีเฟรช</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Loading State -->
        <div id="loadingState" class="flex items-center justify-center py-20">
            <div class="text-center">
                <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">กำลังโหลดข้อมูล...</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
            <div class="flex items-center space-x-3">
                <i data-lucide="alert-circle" class="text-red-500 w-6 h-6"></i>
                <div>
                    <h3 class="font-semibold text-red-800">เกิดข้อผิดพลาด</h3>
                    <p id="errorMessage" class="text-red-600"></p>
                    <button id="retryBtn" class="mt-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                        ลองใหม่
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden fade-in">
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">KPI ทั้งหมด</p>
                            <p id="totalKPIs" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-full">
                            <i data-lucide="target" class="text-blue-600 w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ร้อยละเฉลี่ย</p>
                            <p id="averagePercentage" class="text-2xl font-bold text-gray-900">0%</p>
                        </div>
                        <div class="p-3 bg-purple-100 rounded-full">
                            <i data-lucide="percent" class="text-purple-600 w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ผ่านเกณฑ์</p>
                            <p id="passedKPIs" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="p-3 bg-green-100 rounded-full">
                            <i data-lucide="check-circle" class="text-green-600 w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ไม่ผ่านเกณฑ์</p>
                            <p id="failedKPIs" class="text-2xl font-bold text-red-600">0</p>
                        </div>
                        <div class="p-3 bg-red-100 rounded-full">
                            <i data-lucide="x-circle" class="text-red-600 w-6 h-6"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Panel -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0 lg:space-x-4">
                    <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4 flex-1">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเด็นขับเคลื่อน</label>
                            <select id="groupFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">ทั้งหมด</option>
                            </select>
                        </div>
                        
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">หน่วยบริการ</label>
                            <select id="serviceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">ทั้งหมด</option>
                            </select>
                        </div>
                        
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
                            <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">ทั้งหมด</option>
                                <option value="passed">ผ่านเกณฑ์</option>
                                <option value="failed">ไม่ผ่านเกณฑ์</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="resetFilters" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        รีเซ็ต
                    </button>
                </div>
            </div>

            <!-- KPI Group Cards -->
            <div id="kpiGroups" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Group cards will be inserted here -->
            </div>

            <!-- KPI Detail Table -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 md:mb-0">รายละเอียด KPI</h2>
                        <div class="flex items-center space-x-4">
                            <span id="tableResultCount" class="text-sm text-gray-600">แสดง 0 รายการ</span>
                            <select id="tableSortBy" class="px-3 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="ร้อยละ (%)">เรียงตามร้อยละ</option>
                                <option value="ชื่อหน่วยบริการ">เรียงตามหน่วยบริการ</option>
                                <option value="ประเด็นขับเคลื่อน">เรียงตามประเด็นขับเคลื่อน</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเด็นขับเคลื่อน</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ตัวชี้วัดย่อย</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยบริการ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เป้าหมาย</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผลงาน</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ร้อยละ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่อัพเดท</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ดู source</th>
                            </tr>
                        </thead>
                        <tbody id="kpiTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="tablePagination" class="px-6 py-3 border-t border-gray-200 bg-gray-50">
                    <div class="flex items-center justify-between">
                        <button id="prevPage" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ก่อนหน้า
                        </button>
                        <span id="pageInfo" class="text-sm text-gray-700">หน้า 1 จาก 1</span>
                        <button id="nextPage" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ถัดไป
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Source Data Modal -->
    <div id="sourceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl w-[calc(100vw-4rem)] h-[calc(100vh-4rem)] overflow-hidden">
                <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">ข้อมูลต้นฉบับ</h3>
                        <p id="sourceSheetName" class="text-sm text-gray-600"></p>
                    </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="p-6 overflow-auto h-[calc(100vh-12rem)]">
                    <div id="sourceDataContent" class="overflow-x-auto">
                        <!-- Source data table will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let kpiData = null;
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // Configuration - Replace with your actual Google Apps Script URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwTCVRGkFte39699yAHm5d1suYsU9RUFM8mjtoohhj5uBWfHKsRkSI3MVbRJyw4oU_YKQ/exec';
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeLucideIcons();
            setupEventListeners();
            loadDashboardData();
        });

        // Initialize Lucide icons
        function initializeLucideIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
            document.getElementById('retryBtn').addEventListener('click', loadDashboardData);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            
            // Filter event listeners
            document.getElementById('groupFilter').addEventListener('change', applyFilters);
            document.getElementById('serviceFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('tableSortBy').addEventListener('change', applyFilters);
            
            // Pagination event listeners
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));
            
            // Modal event listeners
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('sourceModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
        }

        // Load dashboard data from API
        async function loadDashboardData() {
            showLoading();
            hideError();
            
            try {
                const response = await fetch(`${API_URL}?action=getAllKPIData`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    kpiData = result.data;
                    updateDashboard();
                    showDashboard();
                } else {
                    throw new Error(result.message || 'Unknown error occurred');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showError(error.message);
            }
        }

        // Update dashboard with loaded data
        function updateDashboard() {
            if (!kpiData) return;
            
            // Update summary stats
            updateSummaryStats();
            
            // Populate filters
            populateFilters();
            
            // Create group cards
            createGroupCards();
            
            // Initialize filtered data
            filteredData = [...kpiData.configuration];
            updateTable();
            
            // Initialize Lucide icons for newly created elements
            initializeLucideIcons();
        }

        // Update summary statistics
        function updateSummaryStats() {
            const summary = kpiData.summary;
            
            document.getElementById('totalKPIs').textContent = summary.totalKPIs.toLocaleString();
            document.getElementById('averagePercentage').textContent = summary.averagePercentage + '%';
            document.getElementById('passedKPIs').textContent = summary.passedKPIs.toLocaleString();
            document.getElementById('failedKPIs').textContent = summary.failedKPIs.toLocaleString();
        }

        // Populate filter dropdowns
        function populateFilters() {
            const groupFilter = document.getElementById('groupFilter');
            const serviceFilter = document.getElementById('serviceFilter');
            
            // Clear existing options (except "ทั้งหมด")
            groupFilter.innerHTML = '<option value="">ทั้งหมด</option>';
            serviceFilter.innerHTML = '<option value="">ทั้งหมด</option>';
            
            // Populate group filter
            kpiData.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });
            
            // Populate service filter
            const services = [...new Set(kpiData.configuration.map(item => item['ชื่อหน่วยบริการ']))];
            services.sort().forEach(service => {
                if (service && service.trim()) {
                    const option = document.createElement('option');
                    option.value = service;
                    option.textContent = service;
                    serviceFilter.appendChild(option);
                }
            });
        }

        // Create group cards
        function createGroupCards() {
            const container = document.getElementById('kpiGroups');
            container.innerHTML = '';
            
            Object.entries(kpiData.summary.groupStats).forEach(([groupName, stats]) => {
                const card = createGroupCard(groupName, stats);
                container.appendChild(card);
            });
        }

        // Create individual group card
        function createGroupCard(groupName, stats) {
            const passRate = stats.count > 0 ? Math.round((stats.passed / stats.count) * 100) : 0;
            const statusClass = stats.averagePercentage >= 80 ? 'status-passed' : 'status-failed';
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-sm overflow-hidden card-hover cursor-pointer';
            card.addEventListener('click', () => filterByGroup(groupName));
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900 text-lg">${groupName}</h3>
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i data-lucide="folder" class="text-blue-600 w-5 h-5"></i>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">จำนวน KPI</span>
                            <span class="font-semibold">${stats.count}</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ร้อยละเฉลี่ย</span>
                            <span class="font-semibold">${stats.averagePercentage}%</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">อัตราผ่าน</span>
                            <span class="font-semibold text-${passRate >= 80 ? 'green' : 'red'}-600">${passRate}%</span>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${statusClass} h-2 rounded-full progress-bar" style="width: ${stats.averagePercentage}%"></div>
                        </div>
                        
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>ผ่าน: ${stats.passed}</span>
                            <span>ไม่ผ่าน: ${stats.failed}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Apply filters
        function applyFilters() {
            const groupFilter = document.getElementById('groupFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredData = kpiData.configuration.filter(item => {
                // Group filter
                if (groupFilter && item['ประเด็นขับเคลื่อน'] !== groupFilter) return false;
                
                // Service filter
                if (serviceFilter && item['ชื่อหน่วยบริการ'] !== serviceFilter) return false;
                
                // Status filter
                if (statusFilter) {
                    const percentage = parseFloat(item['ร้อยละ (%)']) || 0;
                    const threshold = parseFloat(item['เกณฑ์ผ่าน (%)']) || 0;
                    const passed = percentage >= threshold;
                    
                    if (statusFilter === 'passed' && !passed) return false;
                    if (statusFilter === 'failed' && passed) return false;
                }
                
                return true;
            });
            
            // Apply sorting
            const sortBy = document.getElementById('tableSortBy').value;
            filteredData.sort((a, b) => {
                if (sortBy === 'ร้อยละ (%)') {
                    return parseFloat(b[sortBy] || 0) - parseFloat(a[sortBy] || 0);
                } else {
                    return (a[sortBy] || '').toString().localeCompare((b[sortBy] || '').toString(), 'th');
                }
            });
            
            currentPage = 1;
            updateTable();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('groupFilter').value = '';
            document.getElementById('serviceFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('tableSortBy').value = 'ร้อยละ (%)';
            applyFilters();
        }

        // Filter by group (from card click)
        function filterByGroup(groupName) {
            document.getElementById('groupFilter').value = groupName;
            applyFilters();
        }

        // Update table
        function updateTable() {
            const tbody = document.getElementById('kpiTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageData.forEach(item => {
                const row = createTableRow(item);
                tbody.appendChild(row);
            });
            
            updatePagination();
            updateResultCount();
        }

        // Create table row
        function createTableRow(item) {
            const percentage = parseFloat(item['ร้อยละ (%)']) || 0;
            const threshold = parseFloat(item['เกณฑ์ผ่าน (%)']) || 0;
            const passed = percentage >= threshold;
            
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item['ประเด็นขับเคลื่อน'] || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${item['ตัวชี้วัดย่อย'] || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item['ชื่อหน่วยบริการ'] || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatNumber(item['เป้าหมาย'])}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatNumber(item['ผลงาน'])}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="${passed ? 'bg-green-500' : 'bg-red-500'} h-2 rounded-full transition-all duration-300" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <span class="text-sm font-medium ${passed ? 'text-green-600' : 'text-red-600'}">${percentage.toFixed(1)}%</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${passed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        <i data-lucide="${passed ? 'check' : 'x'}" class="w-3 h-3 mr-1"></i>
                        ${passed ? 'ผ่าน' : 'ไม่ผ่าน'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item['ข้อมูลวันที่'] || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="showSourceData('${item.sheet_source}', '${item.service_code_ref}')">
                        <i data-lucide="external-link" class="w-4 h-4 inline mr-1"></i>ดูข้อมูล
                    </button>
                </td>
            `;
            
            return row;
        }

        // Show source data modal
        async function showSourceData(sheetName, serviceCode) {
            if (!sheetName) {
                alert('ไม่มีข้อมูลต้นฉบับ');
                return;
            }
            
            try {
                const modal = document.getElementById('sourceModal');
                const content = document.getElementById('sourceDataContent');
                const sheetNameEl = document.getElementById('sourceSheetName');
                
                sheetNameEl.textContent = sheetName;
                content.innerHTML = '<div class="flex justify-center py-8"><div class="loading-spinner w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full"></div></div>';
                modal.classList.remove('hidden');
                
                const response = await fetch(`${API_URL}?action=getSourceSheetData&param=${encodeURIComponent(sheetName)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const sourceData = result.data;
                    let filteredSourceData = sourceData;
                    
                    // Filter by service code if available
                    if (serviceCode && sourceData.length > 0) {
                        filteredSourceData = sourceData.filter(row => 
                            row['รหัสหน่วยบริการ'] == serviceCode || 
                            row['service_code_ref'] == serviceCode
                        );
                        
                        // If no match found, show all data
                        if (filteredSourceData.length === 0) {
                            filteredSourceData = sourceData;
                        }
                    }
                    
                    content.innerHTML = createSourceDataTable(filteredSourceData);
                } else {
                    content.innerHTML = `<div class="text-center py-8 text-red-600">เกิดข้อผิดพลาด: ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading source data:', error);
                document.getElementById('sourceDataContent').innerHTML = 
                    `<div class="text-center py-8 text-red-600">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>`;
            }
        }

        // Create source data table
        function createSourceDataTable(data) {
            if (!data || data.length === 0) {
                return '<div class="text-center py-8 text-gray-500">ไม่มีข้อมูล</div>';
            }
            
            const headers = Object.keys(data[0]);
            
            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
            `;
            
            headers.forEach(header => {
                html += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`;
            });
            
            html += `
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            data.forEach(row => {
                html += '<tr class="hover:bg-gray-50">';
                headers.forEach(header => {
                    const value = row[header] || '-';
                    html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }

        // Close modal
        function closeModal() {
            document.getElementById('sourceModal').classList.add('hidden');
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            pageInfo.textContent = `หน้า ${currentPage} จาก ${totalPages}`;
        }

        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updateTable();
            }
        }

        // Update result count
        function updateResultCount() {
            document.getElementById('tableResultCount').textContent = 
                `แสดง ${filteredData.length.toLocaleString()} รายการ`;
        }

        // Utility functions
        function formatNumber(value) {
            const num = parseFloat(value);
            return isNaN(num) ? '-' : num.toLocaleString();
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }

        // Make showSourceData globally accessible
        window.showSourceData = showSourceData;
    </script>
</body>
</html>